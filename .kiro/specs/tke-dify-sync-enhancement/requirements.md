# 需求文档

## 项目介绍

本功能旨在将现有的 TKE 文档到 Dify 知识库同步脚本提升至生产就绪状态。脚本目前已有可工作的 V7 版本 URL 提取功能，但需要在内容抓取健壮性、变更检测可靠性、Dify API 集成和自动化部署能力方面进行改进。目标是创建一个容错、安全且完全自动化的系统，能够在 CVM 服务器上可靠运行，具备适当的错误处理和监控功能。

## 需求列表

### 需求 1

**用户故事：** 作为系统管理员，我希望有健壮的内容抓取功能和全面的错误处理，以便单个页面失败不会导致整个同步过程崩溃。

#### 验收标准

1. 当 URL 请求超时时，系统应记录超时错误并继续处理其他 URL
2. 当出现 HTTP 404 或 503 错误时，系统应记录具体错误代码并跳过该 URL
3. 当页面中找不到 content-layout-container 选择器时，系统应记录警告并为该 URL 返回 None
4. 当发生任何 requests.RequestException 时，系统应捕获异常、记录日志并继续处理
5. 当内容抓取因任何原因失败时，系统应确保失败不会终止整个脚本执行

### 需求 2

**用户故事：** 作为系统管理员，我希望有可靠的变更检测和原子状态更新，以便失败的 Dify 上传可以在后续运行中重试而不丢失数据。

#### 验收标准

1. 当文档成功上传到 Dify 时，系统应使用新哈希值更新本地状态文件
2. 当 Dify 上传失败时，系统不应更新该文档的本地状态文件
3. 当状态文件损坏或缺失时，系统应创建新的空状态并记录问题
4. 当比较内容哈希时，系统应正确识别新文档（无先前哈希）和修改文档（哈希不匹配）
5. 当保存状态时，系统应确保原子写入以防止脚本中断期间的损坏

### 需求 3

**用户故事：** 作为注重安全的管理员，我希望通过统一的配置管理方式管理 API 凭据和其他配置项，以便敏感信息安全存储且易于更换。

#### 验收标准

1. 当脚本启动时，应优先从环境变量读取 DIFY_API_KEY 和 DIFY_KNOWLEDGE_BASE_ID
2. 当环境变量不存在时，系统应尝试从配置文件（如 .env 文件）读取配置
3. 当缺少必需的配置项时，系统应记录详细错误信息并优雅终止
4. 当配置存在时，系统应将其用于所有 Dify API 调用
5. 当脚本部署时，源代码中不应显示任何 API 凭据
6. 当需要更换密钥时，管理员应能够通过修改环境变量或配置文件来实现，无需修改代码
7. 当配置文件存在时，系统应确保配置文件具有适当的文件权限（如 600）以保护敏感信息

### 需求 4

**用户故事：** 作为内容管理员，我希望在 Dify 中有智能的文档更新处理，以便现有文档得到适当更新而不是创建重复项，并且能够通过唯一标识符正确区分不同的文档。

#### 验收标准

1. 当创建文档标识符时，系统应使用完整的 URL 路径作为唯一标识符以确保文档唯一性
2. 当 Dify 中已存在相同 URL 标识符的文档时，系统应更新现有文档而不是创建重复项
3. 当更新文档失败时，系统应尝试删除并重新上传文档
4. 当 Dify API 返回认证错误时，系统应记录具体错误并停止处理
5. 当 Dify API 返回速率限制错误时，系统应实施适当的退避和重试逻辑
6. 当 Dify API 调用失败时，系统应返回 False 以防止状态文件更新
7. 当处理文档名称时，系统应从 URL 中提取有意义的文档标题，同时保持 URL 作为唯一标识符

### 需求 5

**用户故事：** 作为 DevOps 工程师，我希望有全面的部署文档，以便能够在任何 CVM 服务器上从零开始设置自动化同步。

#### 验收标准

1. 当遵循部署指南时，所有必需的系统包应可通过提供的命令安装
2. 当设置环境时，Python 依赖项应可从生成的 requirements.txt 文件安装
3. 当配置 cron 作业时，提供的 crontab 命令应包含用于无头浏览器支持的 Xvfb 包装器
4. 当通过 cron 运行时，脚本应在正确的目录中执行，并进行适当的环境变量注入
5. 当脚本运行时，所有输出应记录到文件中以便监控和调试

### 需求 6

**用户故事：** 作为系统监控员，我希望整个应用程序有全面的错误处理和日志记录，以便能够快速诊断和解决问题。

#### 验收标准

1. 当任何 API 调用失败时，系统应记录具体的错误代码、消息和受影响的 URL
2. 当发生网络超时时，系统应记录超时详情并继续处理
3. 当文件操作失败时，系统应记录文件路径和错误详情
4. 当脚本完成时，应记录已处理、已更新和失败文档的汇总统计信息
5. 当在生产环境中运行时，所有日志应包含时间戳和适当的日志级别

### 需求 7

**用户故事：** 作为系统管理员，我希望脚本安全地处理临时文件，以便执行后文件系统中不会留下敏感内容。

#### 验收标准

1. 当为 Dify 上传创建临时文件时，系统应使用安全的临时文件创建
2. 当 API 调用完成时（成功或失败），应清理所有临时文件
3. 当脚本被中断时，临时文件不应在文件系统中累积
4. 当处理文件上传时，系统应使用适当的文件权限
5. 当清理资源时，系统应确保临时位置中不会残留敏感数据