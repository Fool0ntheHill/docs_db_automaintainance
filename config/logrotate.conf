# TKE 文档同步系统 - logrotate 配置
# 安装位置: /etc/logrotate.d/tke-dify-sync
# 安装命令: sudo cp config/logrotate.conf /etc/logrotate.d/tke-dify-sync

# 主日志文件轮转配置
/opt/tke-dify-sync/logs/*.log {
    # 每日轮转
    daily
    
    # 如果日志文件不存在，不报错
    missingok
    
    # 保留最近 14 天的日志
    rotate 14
    
    # 压缩旧的日志文件
    compress
    
    # 延迟压缩，保留最新的轮转文件不压缩
    delaycompress
    
    # 如果日志文件为空，不进行轮转
    notifempty
    
    # 轮转后创建新的日志文件，设置权限和所有者
    create 644 root root
    
    # 使用日期作为后缀
    dateext
    
    # 日期格式
    dateformat -%Y%m%d
    
    # 轮转后执行的命令
    postrotate
        # 重新加载 rsyslog 服务（如果使用）
        /bin/kill -HUP `cat /var/run/rsyslogd.pid 2> /dev/null` 2> /dev/null || true
        
        # 可以在这里添加其他需要在日志轮转后执行的命令
        # 例如：发送通知、清理临时文件等
    endscript
    
    # 复制并截断原文件，而不是移动
    copytruncate
    
    # 强制轮转，即使文件很小
    # size 1M
    
    # 设置最大年龄，超过此时间的文件将被删除
    maxage 30
}

# 特定的大日志文件配置（如果存在）
/opt/tke-dify-sync/logs/cron_*.log {
    daily
    missingok
    rotate 7
    compress
    delaycompress
    notifempty
    create 644 root root
    dateext
    dateformat -%Y%m%d
    copytruncate
    
    # 当文件大于 10MB 时强制轮转
    size 10M
    
    postrotate
        # 记录轮转事件到系统日志
        logger "TKE Dify Sync: Log rotation completed for cron logs"
    endscript
}

# 错误日志特殊处理
/opt/tke-dify-sync/logs/*error*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 root root
    dateext
    dateformat -%Y%m%d
    copytruncate
    
    # 错误日志保留更长时间
    maxage 60
    
    postrotate
        # 如果有错误日志轮转，发送通知（可选）
        # echo "TKE Dify Sync error log rotated" | mail -s "Log Rotation Alert" admin@example.com
        logger "TKE Dify Sync: Error log rotation completed"
    endscript
}

# 调试日志配置（如果启用调试模式）
/opt/tke-dify-sync/logs/*debug*.log {
    daily
    missingok
    rotate 3
    compress
    delaycompress
    notifempty
    create 644 root root
    dateext
    dateformat -%Y%m%d
    copytruncate
    
    # 调试日志只保留短期
    maxage 7
    
    # 当文件大于 50MB 时强制轮转
    size 50M
}